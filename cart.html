<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - Petshop Chiquitines</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <meta name="robots" content="index, follow">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <!-- Desktop Navigation (Centered) -->
                <nav class="nav-desktop">
                    <a href="index.html" class="nav-link">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        </svg>
                        <span>Inicio</span>
                    </a>
                    <a href="products.html" class="nav-link">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        </svg>
                        <span>Productos</span>
                    </a>
                </nav>

                <!-- Cart Icon (Right) -->
                <div class="header-actions">
                    <a href="cart.html" class="cart-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        <span class="cart-count" id="cartCount">0</span>
                    </a>
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <nav>
                <a href="index.html" class="mobile-nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    </svg>
                    <span>Inicio</span>
                </a>
                <a href="products.html" class="mobile-nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                    <span>Productos</span>
                </a>
            </nav>
        </div>
    </header>

    <!-- Cart Page -->
    <div class="cart-page">
        <div class="container">
            <a href="products.html" class="back-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                <span>Seguir comprando</span>
            </a>

            <h1 style="font-size: 1.875rem; font-weight: bold; margin-bottom: 1.5rem;">Carrito de Compras</h1>

            <div id="cartContent">
                <!-- Cart content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p class="copyright">¬© 2026 Chiquitines. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script src="app.js"></script>
    <script>
        // Check if dependencies are loaded
        if (typeof getCart !== 'function') {
            console.error('app.js no cargado correctamente');
            document.getElementById('cartContent').innerHTML = `
                <div style="min-height: 50vh; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #ef4444;">
                        <h2>Error al cargar recursos</h2>
                        <p>Por favor recarga la p√°gina</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
                            Recargar P√°gina
                        </button>
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
        });

        function loadCart() {
            const cart = getCart();
            const cartContent = document.getElementById('cartContent');

            if (cart.length === 0) {
                cartContent.innerHTML = `
                    <div style="min-height: 50vh; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" style="margin: 0 auto 1rem;">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Tu carrito est√° vac√≠o</h2>
                            <p style="color: #6b7280; margin-bottom: 1.5rem;">Agrega productos para comenzar tu pedido</p>
                            <a href="products.html" class="btn-primary">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="19" y1="12" x2="5" y2="12"></line>
                                    <polyline points="12 19 5 12 12 5"></polyline>
                                </svg>
                                <span>Ver Productos</span>
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            cartContent.innerHTML = `
                <div class="cart-layout">
                    <div class="cart-items" id="cartItems"></div>
                    <div class="order-form" id="orderForm"></div>
                </div>
            `;

            renderCartItems();
            renderOrderForm();
        }

        function renderCartItems() {
            const cart = getCart();
            const cartItems = document.getElementById('cartItems');

            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item" data-product-id="${item.id}">
                    <div class="cart-item-content">
                        <img src="${item.imageUrl || 'https://images.unsplash.com/photo-1589924691995-400dc9ecc119?w=400'}" 
                             alt="${item.name}" 
                             class="cart-item-image"
                             loading="lazy">
                        <div class="cart-item-details">
                            <h3 class="cart-item-name">${item.name}</h3>
                            <p class="cart-item-meta">${item.brand} - ${item.weight}</p>
                            <div class="cart-item-actions">
                                <div class="quantity-controls">
                                    <button class="quantity-btn" onclick="changeQuantity('${item.id}', -1)" aria-label="Disminuir cantidad">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                    <span class="quantity-value">${item.quantity}</span>
                                    <button class="quantity-btn" onclick="changeQuantity('${item.id}', 1)" aria-label="Aumentar cantidad">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>
                                <div class="cart-item-price">
                                    <p class="cart-item-total">${formatPrice(item.price * item.quantity)}</p>
                                    <p class="cart-item-unit-price">${formatPrice(item.price)} c/u</p>
                                </div>
                            </div>
                        </div>
                        <button class="remove-btn" onclick="removeItemWithAnimation('${item.id}')" aria-label="Eliminar producto">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderOrderForm() {
            const orderForm = document.getElementById('orderForm');
            const total = calculateTotal();

            orderForm.innerHTML = `
                <h2>Datos del Pedido</h2>

                <div class="form-group">
                    <label for="customerName">Nombre *</label>
                    <input type="text" id="customerName" placeholder="Tu nombre" required>
                    <span class="error-message" id="nameError"></span>
                </div>

                <div class="form-group">
                    <label>M√©todo de Entrega *</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="delivery" value="delivery" checked>
                            <span>Delivery (te contactaremos para coordinar)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="delivery" value="pickup">
                            <span>Retiro en local/Pickup</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>M√©todo de Pago *</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="payment" value="efectivo" checked>
                            <span>Efectivo</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="payment" value="transferencia">
                            <span>Transferencia</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-option">
                        <input type="checkbox" id="needsInvoice" onchange="toggleInvoiceFields()">
                        <span style="font-weight: 600;">Necesito factura</span>
                    </label>
                    <div id="invoiceFields" style="display: none; margin-top: 0.75rem;">
                        <input type="text" id="invoiceRuc" placeholder="RUC" style="margin-bottom: 0.75rem; width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem 0.75rem;">
                        <span class="error-message" id="rucError"></span>
                        <input type="text" id="invoiceName" placeholder="Nombre o Raz√≥n Social" style="width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem 0.75rem; margin-top: 0.75rem;">
                        <span class="error-message" id="invoiceNameError"></span>
                    </div>
                </div>

                <div class="order-total">
                    <div class="total-row">
                        <span style="color: #6b7280;">Subtotal</span>
                        <span style="font-weight: 600;" id="subtotalAmount">${formatPrice(total)}</span>
                    </div>
                    <div class="total-row final">
                        <span>Total</span>
                        <span class="total-amount" id="totalAmount">${formatPrice(total)}</span>
                    </div>
                </div>

                <button class="submit-btn" onclick="sendToWhatsApp()" id="submitBtn">
                    Enviar Pedido por WhatsApp
                </button>
            `;
        }

        // Optimized quantity change - only update specific elements
        function changeQuantity(productId, change) {
            if (!updateQuantity(productId, change)) {
                return; // updateQuantity returns false if bounds are exceeded
            }

            // Get updated item
            const cart = getCart();
            const item = cart.find(i => i.id === productId);
            
            if (!item) return;

            // Update only the specific item's display
            const itemElement = document.querySelector(`[data-product-id="${productId}"]`);
            if (itemElement) {
                const quantityEl = itemElement.querySelector('.quantity-value');
                const priceEl = itemElement.querySelector('.cart-item-total');
                
                if (quantityEl) quantityEl.textContent = item.quantity;
                if (priceEl) priceEl.textContent = formatPrice(item.price * item.quantity);
            }

            // Update totals
            updateOrderTotal();
        }

        // Remove item with animation
        function removeItemWithAnimation(productId) {
            const itemEl = document.querySelector(`[data-product-id="${productId}"]`);
            
            if (itemEl) {
                itemEl.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                itemEl.style.opacity = '0';
                itemEl.style.transform = 'translateX(-20px)';
                
                setTimeout(() => {
                    removeFromCart(productId);
                    loadCart();
                }, 300);
            } else {
                removeFromCart(productId);
                loadCart();
            }
        }

        function updateOrderTotal() {
            const total = calculateTotal();
            const subtotalEl = document.getElementById('subtotalAmount');
            const totalEl = document.getElementById('totalAmount');
            
            if (subtotalEl) subtotalEl.textContent = formatPrice(total);
            if (totalEl) totalEl.textContent = formatPrice(total);
        }

        function calculateTotal() {
            const cart = getCart();
            return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        function toggleInvoiceFields() {
            const needsInvoice = document.getElementById('needsInvoice').checked;
            const invoiceFields = document.getElementById('invoiceFields');
            invoiceFields.style.display = needsInvoice ? 'block' : 'none';
            
            // Clear errors when toggling
            if (!needsInvoice) {
                clearError('rucError');
                clearError('invoiceNameError');
            }
        }

        // Improved validation with visual feedback
        function validateForm() {
            let isValid = true;
            
            // Clear all previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('input, textarea').forEach(el => el.classList.remove('input-error'));

            // Validate name
            const customerName = document.getElementById('customerName');
            if (!customerName.value.trim()) {
                showFieldError('nameError', 'Por favor ingresa tu nombre');
                customerName.classList.add('input-error');
                isValid = false;
            }

            // Validate invoice fields if needed
            const needsInvoice = document.getElementById('needsInvoice').checked;
            if (needsInvoice) {
                const invoiceRuc = document.getElementById('invoiceRuc');
                const invoiceName = document.getElementById('invoiceName');
                
                if (!invoiceRuc.value.trim()) {
                    showFieldError('rucError', 'Por favor ingresa el RUC');
                    invoiceRuc.classList.add('input-error');
                    isValid = false;
                }
                
                if (!invoiceName.value.trim()) {
                    showFieldError('invoiceNameError', 'Por favor ingresa el nombre o raz√≥n social');
                    invoiceName.classList.add('input-error');
                    isValid = false;
                }
            }

            return isValid;
        }

        function showFieldError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.color = '#ef4444';
                errorEl.style.fontSize = '0.875rem';
                errorEl.style.marginTop = '0.25rem';
                errorEl.style.display = 'block';
            }
        }

        function clearError(elementId) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = '';
            }
        }

        function sendToWhatsApp() {
            // Validate form
            if (!validateForm()) {
                // Scroll to first error
                const firstError = document.querySelector('.input-error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }

            // Disable button to prevent double submission
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>Enviando...</span>';

            // Get form data
            const customerName = document.getElementById('customerName').value.trim();
            const deliveryMethod = document.querySelector('input[name="delivery"]:checked').value;
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const needsInvoice = document.getElementById('needsInvoice').checked;
            const invoiceRuc = document.getElementById('invoiceRuc')?.value.trim();
            const invoiceName = document.getElementById('invoiceName')?.value.trim();

            // Build WhatsApp message
            const cart = getCart();
            let message = '*NUEVO PEDIDO - Petshop Chiquitines*\n\n';
            message += `üë§ *Cliente:* ${customerName}\n\n`;
            
            message += 'üì¶ *Productos:*\n';
            cart.forEach((item, index) => {
                message += `${index + 1}. ${item.name}\n`;
                message += `   Cantidad: ${item.quantity}\n`;
                message += `   Precio unitario: ${formatPrice(item.price)}\n`;
                message += `   Subtotal: ${formatPrice(item.price * item.quantity)}\n\n`;
                message += `   C√≥digo: ${item.code}\n`;
            });

            message += `üí∞ *TOTAL: ${formatPrice(calculateTotal())}*\n\n`;

            message += `üöö *Entrega:* ${deliveryMethod === 'delivery' ? 'Delivery' : 'Retiro en local/Pickup'}\n\n`;

            message += `üí≥ *M√©todo de pago:* ${paymentMethod === 'efectivo' ? 'Efectivo' : 'Transferencia'}\n\n`;

            if (needsInvoice) {
                message += 'üßæ *Factura:*\n';
                message += `   RUC: ${invoiceRuc}\n`;
                message += `   Nombre: ${invoiceName}\n`;
            } else {
                message += 'üßæ *Factura:* No requiere\n';
            }

            // Encode and open WhatsApp
            try {
                const encodedMessage = encodeURIComponent(message);
                const whatsappNumber = '595976106726'; // CAMBIAR POR TU N√öMERO
                const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;

                window.open(whatsappUrl, '_blank');

                // Clear cart after successful send
                setTimeout(() => {
                    localStorage.removeItem('cart');
                    showNotification('¬°Pedido enviado con √©xito!');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                }, 500);
                
            } catch (error) {
                console.error('Error al enviar pedido:', error);
                showNotification('Error al enviar el pedido. Intenta nuevamente.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Add input event listeners for real-time validation feedback
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Clear errors on input
                const nameInput = document.getElementById('customerName');
                if (nameInput) {
                    nameInput.addEventListener('input', () => {
                        if (nameInput.value.trim()) {
                            nameInput.classList.remove('input-error');
                            clearError('nameError');
                        }
                    });
                }
            }, 100);
        });
    </script>

    <style>
        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }

        .error-message {
            display: block;
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .cart-item {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
    </style>
</body>
</html>
